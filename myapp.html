<!DOCTYPE html>
<html>

<head>
    <title>Revisions by User</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        //ToDo: get rid of double Subscription endpoint request, tune performance

        Rally.onReady(function () {
            Ext.define('CustomApp', {
                extend: 'Rally.app.App',
                componentCls: 'app',
                _subscriptions: [],
                _subscriptionRevHistory: null,
                items: [
                    { xtype: 'container', itemId: 'selector_box' },
                    { xtype: 'container', itemId: 'display_box' }
                ],

                getSelectorBox: function () {
                    return this.down('#selector_box');
                },
                getDisplayBox: function () {
                    return this.down('#display_box');
                },
                getStartDate: function () {
                    return this.down('#startDate').getValue();
                },
                getEndDate: function () {
                    if (this.down('#endDate').getValue()) {
                        //add a day since the datepicker gives us the new day at midnight.
                        return Rally.util.DateTime.add(this.down('#endDate').getValue(), 'day', 1);
                    }
                    return null;
                },

                addPickers: function() {
                    this.getSelectorBox().removeAll();
                    var defaultToDate = new Date();
                    defaultToDate.setDate(defaultToDate.getDate() - 30);

                    this.getSelectorBox().add({
                        xtype: 'container',
                        layout: 'hbox',
                        margin: '10 0 0 0',
                        items: [{
                            xtype: 'rallydatefield',
                            itemId: 'startDate',
                            value:  defaultToDate,
                            fieldLabel: 'Date from',
                            labelAlign: 'right',
                            labelWidth: 100,
                            width: 275,
                            labelSeparator: ''

                        }, {
                            xtype: 'rallydatefield',
                            itemId: 'endDate',
                            value: new Date(),
                            fieldLabel: 'to',
                            labelAlign: 'right',
                            labelWidth: 25,
                            width: 225,
                            labelSeparator: ''
                        }, {
                            xtype: 'rallybutton',
                            text: 'Get Revisions',
                            margin: '0 10 0 10',
                            listeners: {
                                click: this.updateView,
                                scope: this
                            }
                        }]
                    });
                },

                updateView: function() {
                    this.getDisplayBox().removeAll();
                    this.loadRevisions();
                },

                getRevisionsByDate: function () {
                    var promises = [];
                    var revisions = this._subscriptionRevHistory.get('Revisions');
                    var startDateString = this.getStartDate().toISOString();
                    var endDateString = this.getEndDate().toISOString();
                    revisions.store = this._subscriptionRevHistory.getCollection('Revisions', {
                        fetch: ['User', 'Description', 'CreationDate', 'RevisionNumber'],
                        filters: [{
                            property: 'CreationDate',
                            operator: '>=',
                            value: startDateString
                            }, {
                            property: 'CreationDate',
                            operator: '<=',
                            value: endDateString
                        }]
                    });
                    promises.push(revisions.store.load());
                    return Deft.Promise.all(promises);
                },

                loadRevisions: function() {
                    var that = this;
                    this.setLoading(true);

                    this.getRevisionsByDate().then({
                        success: function (results) {
                            that._makeGrid(results);
                        },
                        failure: function () {
                            console.log("oh noes!");
                        }
                    }).always(function(){this.setLoading(false);}, this);
                },

                launch: function () {
                    var that = this;
                    var subStore = Ext.create('Rally.data.wsapi.Store', {
                        model: 'Subscription',
                        fetch: ['ObjectID', 'RevisionHistory', 'Revisions', 'Description', 'User'],
                        autoLoad: true
                    });

                    this.addPickers();

                    subStore.load().then({
                        success: this._getRevHistoryModel,
                        scope: this
                    }).then({
                        success: this._onRevHistoryModelCreated,
                        scope: this
                    }).then({
                        success: this._onRevHistoryModelLoaded,
                        scope: this
                    });
                },

                _getRevHistoryModel: function (subs) {
                    this._subscriptions = subs;
                    return Rally.data.ModelFactory.getModel({
                        type: 'RevisionHistory'
                    });
                },

                _onRevHistoryModelCreated: function (model) {
                    var promises = [];
                    var subscription = this._subscriptions[0];
                    var ref = subscription.get('RevisionHistory')._ref;
                    promises.push(model.load(Rally.util.Ref.getOidFromRef(ref)));
                    return Deft.Promise.all(promises);
                },

                _onRevHistoryModelLoaded: function (histories) {
                    this._subscriptionRevHistory = histories[0];
                },

                _makeGrid: function (revs) {
                    this.getDisplayBox().removeAll();
                    this.getDisplayBox().add({
                        xtype: 'rallygrid',
                        showPagingToolbar: true,
                        showRowActionsColumn: false,
                        editable: false,
                        store: Ext.create('Rally.data.custom.Store', {
                            data: revs[0]
                        }),
                        columnCfgs: [{
                            text: 'User',
                            dataIndex: 'User',
                            renderer: function (value) {
                                return value._refObjectName;
                            }
                        },
                        {
                            text: 'Revision number',
                            dataIndex: 'RevisionNumber',
                            renderer: function (value) {
                                return value
                            }
                        },
                        {
                            text: 'Date',
                            dataIndex: 'CreationDate',
                            renderer: function (value) {
                                return value.toDateString();
                            }
                        },
                        {
                            text: 'Description',
                            dataIndex: 'Description',
                            flex: 1,
                            renderer: function (value) {
                                return value
                            }
                        }
                        ]
                    });

                }

            });

            Rally.launchApp('CustomApp', {
                name: "App: Subscription Revisions by Date Range",
                parentRepos: ""
            });

        });
    </script>
</head>

<body></body>

</html>